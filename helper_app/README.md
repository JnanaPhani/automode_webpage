# Zenith Tek Sensor Helper

Local companion service that allows the web portal to configure Epson M-A542VR1 and M-G552PR80 sensors without using the browser-only Web Serial API.

## Features

- Maintains a persistent serial session with automatic drain loop and recovery.
- Exposes an HTTP API (`http://127.0.0.1:7421`) for `pair`, `status`, `connect`, `detect`, `configure`, `exit-auto`, and `reset`.
- Supports `/update` (manifest lookup) and `/update/download` (local package fetch).
- Streams logs to the browser via WebSocket (`/logs`).
- Checks Supabase for newer helper releases.
- Downloads update packages to `~/.zenith_helper/updates` (configurable via `ZENITH_HELPER_UPDATES_DIR`).
- Provides a one-time `/pair` endpoint so the web app can retrieve the auth token automatically without user interaction.

## Running Locally

```bash
cd helper_app
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp env.example .env     # edit if necessary
python cli.py
```

By default the API token is stored in `~/.zenith_helper_token`. Include the header `X-Zenith-Token: <token>` in all requests.

## Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `ZENITH_SUPABASE_URL` | – | Supabase project URL used for update manifests. |
| `ZENITH_SUPABASE_ANON_KEY` | – | Public anon key for Supabase REST requests. |
| `ZENITH_HELPER_UPDATES_DIR` | `~/.zenith_helper/updates` | Directory where downloaded installers are stored. |
| `ZENITH_HELPER_UPDATE_POLL_INTERVAL` | `21600` (6h) | Background polling interval (seconds) for Supabase update checks. |
| `ZENITH_HELPER_ALLOWED_ORIGINS` | `http://localhost:5173,http://127.0.0.1:5173,https://localhost:5173` | Comma-separated list of web origins allowed to call the helper (used by CORS and `/pair`). |
| `ZENITH_HELPER_HOST` / `ZENITH_HELPER_PORT` | `127.0.0.1:7421` | Network binding override. |
| `ZENITH_HELPER_BAUD` | `460800` | Default serial baud rate. |
| `ZENITH_HELPER_LOG_LEVEL` | `INFO` | Root log level. |

## Supabase

Create table:

```sql
create table helper_updates (
  id bigint generated by default as identity primary key,
  version text not null,
  platform text not null,
  download_url text not null,
  checksum text,
  release_notes text,
  inserted_at timestamptz default now()
);

create index helper_updates_version_idx on helper_updates (version desc);
```

Upload installer packages to a Supabase Storage bucket and store the public URLs in the table.

## Packaging Notes

- Windows: PyInstaller exe + service wrapper.
- macOS: app bundle + LaunchAgent.
- Linux: AppImage or deb + systemd user service.

Set the environment variables (`ZENITH_SUPABASE_URL`, `ZENITH_SUPABASE_ANON_KEY`) in the packaged runtime to enable update checks.

